---

- shell: cat /tmp/master.count
  register: master_result

- stat: path=/var/lib/jenkins
  register: jenkins_dir

- name: install mesos slave packages
  yum: name={{ item }} state=latest
  with_items:
    - "{{ stable_mesos_package_version }}"

- name: disable mesos update
  lineinfile:
    dest=/etc/yum.conf
    line="{{ item.line }}"
    insertafter='EOF'
  with_items:
    - { line: 'exclude=mesos-*' }

- name: Delete old zk entry
  file: path=/etc/mesos/zk state=absent

- name: configure zk access
  lineinfile: dest=/etc/mesos/zk create=yes state=present regexp="^localhost" line="zk://{{ hostvars[groups['master1'][0]].ansible_default_ipv4.address }}:2181,{{ hostvars[groups['master2'][0]].ansible_default_ipv4.address }}:2181,{{ hostvars[groups['master3'][0]].ansible_default_ipv4.address }}:2181/mesos"
  when: "'three' in master_result.stdout"

- name: configure zk access
  lineinfile: dest=/etc/mesos/zk create=yes state=present regexp="^localhost" line="zk://{{ hostvars[groups['master1'][0]].ansible_default_ipv4.address }}:2181,{{ hostvars[groups['master2'][0]].ansible_default_ipv4.address }}:2181,{{ hostvars[groups['master3'][0]].ansible_default_ipv4.address }}:2181,{{ hostvars[groups['master4'][0]].ansible_default_ipv4.address }}:2181,{{ hostvars[groups['master5'][0]].ansible_default_ipv4.address }}:2181/mesos"
  when: "'five' in master_result.stdout"

- name: clean blank spaces in zk config
  shell: sed -i '/^\s*$/d' /etc/mesos/zk

- name: set hostname in mesos
  lineinfile: dest=/etc/mesos-slave/hostname state=present line="{{ ansible_fqdn }}" create=yes

- name: increase the mesos-slave executor timeout
  lineinfile: dest=/etc/mesos-slave/executor_registration_timeout state=present line="5mins" create=yes

- name: set slave ip in mesos
  lineinfile: dest=/etc/mesos-slave/ip state=present create=yes line="{{ ansible_default_ipv4.address }}"
  notify: restart mesos-slave

- name: ensure mesos-slave service is started and enabled
  service:
    name: "{{ item }}"
    enabled: yes
    state: started
  with_items:
    - mesos-slave
  when: jenkins_dir.stat.exists == False

- name: stop unneeded services
  service:
    name: "{{ item }}"
    enabled: no
    state: stopped
  with_items:
    - mesos-master

- user: name=jenkins comment="Jenkins user" shell=/bin/bash state=present
